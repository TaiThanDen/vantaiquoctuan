      - name: Deploy to VPS
        shell: bash
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          set -e

          APP_NAME="vantaituanhai"
          BUNDLE_NAME="vantaituanhai_bundle.tar.gz"

          echo "==> Tạo staging dir..."
          rm -rf .deploy_staging
          mkdir -p .deploy_staging

          echo "==> Copy source + build output vào staging..."
          rsync -a \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".deploy_staging" \
            ./ .deploy_staging/

          echo "==> Đóng gói từ staging (ổn định, không bị file-change)..."
          tar -C .deploy_staging -czf "$BUNDLE_NAME" .

          echo "==> Upload bundle lên VPS..."
          scp -i ~/.ssh/id_ed25519 \
            -P 22 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            "$BUNDLE_NAME" "$USER@$HOST:/tmp/$BUNDLE_NAME"

          echo "==> Chạy lệnh trên VPS..."
          REMOTE_CMD="set -e;
            mkdir -p '$PROJECT_DIR';
            tar -xzf /tmp/$BUNDLE_NAME -C '$PROJECT_DIR' --strip-components=0;
            rm -f /tmp/$BUNDLE_NAME;

            cd '$PROJECT_DIR';

            npm ci --omit=dev || npm install --omit=dev;

            pm2 describe '$APP_NAME' >/dev/null 2>&1 \
              && pm2 restart '$APP_NAME' --update-env \
              || pm2 start npm --name '$APP_NAME' -- run start -- -p 3000;

            pm2 save || true;
            echo '==> Deploy xong.';
          "

          ssh -i ~/.ssh/id_ed25519 \
            -p 22 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            -o ConnectTimeout=10 \
            "$USER@$HOST" "$REMOTE_CMD"
