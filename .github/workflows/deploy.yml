name: Deploy Next.js to VPS (Nginx + PM2)

on:
  push:
    branches: [main]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps & build
        env:
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          set -e
          npm ci
          npm run build

      - name: Setup SSH
        shell: bash
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          HOST: ${{ secrets.HOST }}
        run: |
          set -e
          mkdir -p ~/.ssh

          printf "%s\n" "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -p 22 -H "$HOST" >> ~/.ssh/known_hosts || true
          ssh-keygen -lf ~/.ssh/id_ed25519

      - name: Deploy to VPS
        shell: bash
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          set -euo pipefail

          APP_NAME="vantaituanhai"
          BUNDLE_NAME="vantaituanhai_bundle.tar.gz"

          echo "==> Tạo snapshot thư mục để đóng gói (tránh file thay đổi khi tar)..."
          SNAPSHOT_DIR="$(mktemp -d)"
          echo "Snapshot dir: $SNAPSHOT_DIR"

          # Copy toàn bộ project sang snapshot, loại thứ không cần
          rsync -a --delete \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude=".next/cache" \
            --exclude=".next/trace" \
            --exclude="*.log" \
            ./ "$SNAPSHOT_DIR/"

          echo "==> Đóng gói bundle từ snapshot..."
          # Tar từ snapshot sẽ ổn định, không bị "file changed as we read it"
          (cd "$SNAPSHOT_DIR" && tar -czf "/home/runner/work/${{ github.repository }}/$BUNDLE_NAME" .) || {
            echo "==> TAR FAILED. Debug snapshot content:"
            ls -la "$SNAPSHOT_DIR" || true
            echo "==> Listing .next (if exists):"
            ls -la "$SNAPSHOT_DIR/.next" || true
            exit 1
          }

          echo "==> Upload bundle lên VPS..."
          scp -i ~/.ssh/id_ed25519 \
            -P 22 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            "$BUNDLE_NAME" "$USER@$HOST:/tmp/$BUNDLE_NAME"

          echo "==> Chạy lệnh trên VPS..."
          REMOTE_CMD="set -e;
            APP_NAME='$APP_NAME';
            PROJECT_DIR='$PROJECT_DIR';
            BUNDLE_NAME='$BUNDLE_NAME';

            echo '==> Tạo thư mục dự án nếu chưa có...';
            mkdir -p \"\$PROJECT_DIR\";

            echo '==> Giải nén bundle vào dự án...';
            tar -xzf \"/tmp/\$BUNDLE_NAME\" -C \"\$PROJECT_DIR\" --strip-components=1;
            rm -f \"/tmp/\$BUNDLE_NAME\";

            cd \"\$PROJECT_DIR\";

            echo '==> Cài deps production...';
            npm ci --omit=dev || npm install --omit=dev;

            echo '==> Restart PM2...';
            pm2 describe \"\$APP_NAME\" >/dev/null 2>&1 \
              && pm2 restart \"\$APP_NAME\" --update-env \
              || pm2 start npm --name \"\$APP_NAME\" -- run start -- -p 3000;

            pm2 save || true;
            echo '==> Deploy xong.';
          "

          ssh -i ~/.ssh/id_ed25519 \
            -p 22 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            -o ConnectTimeout=10 \
            "$USER@$HOST" "$REMOTE_CMD"
