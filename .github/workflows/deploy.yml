name: Deploy Next.js to VPS (Nginx + PM2)

on:
  push:
    branches: [main]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps & build
        env:
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          set -e
          npm ci
          npm run build

      - name: Setup SSH
        shell: bash
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          HOST: ${{ secrets.HOST }}
        run: |
          set -e
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p 22 -H "$HOST" >> ~/.ssh/known_hosts || true
          ssh-keygen -lf ~/.ssh/id_ed25519

      - name: Deploy to VPS (releases + current symlink)
        shell: bash
        env:
          HOST: ${{ secrets.HOST }}
          USER: ${{ secrets.USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          set -euo pipefail

          APP_NAME="vantaituanhai"
          BUNDLE_NAME="vantaituanhai_bundle.tar.gz"

          echo "==> Tạo snapshot để đóng gói..."
          SNAPSHOT_DIR="$(mktemp -d)"
          rsync -a --delete \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude=".next/cache" \
            --exclude=".next/trace" \
            --exclude="*.log" \
            ./ "$SNAPSHOT_DIR/"

          echo "==> Tar bundle..."
          (cd "$SNAPSHOT_DIR" && tar -czf "$GITHUB_WORKSPACE/$BUNDLE_NAME" .)

          echo "==> Upload bundle lên VPS..."
          scp -i ~/.ssh/id_ed25519 \
            -P 22 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            "$BUNDLE_NAME" "$USER@$HOST:/tmp/$BUNDLE_NAME"

          echo "==> Deploy trên VPS..."
          REMOTE_CMD="set -euo pipefail;
            APP_NAME='$APP_NAME';
            BASE_DIR='$PROJECT_DIR';
            BUNDLE_NAME='$BUNDLE_NAME';

            TS=\$(date +%Y%m%d%H%M%S);
            RELEASE_DIR=\"\$BASE_DIR/releases/\$TS\";
            CURRENT_DIR=\"\$BASE_DIR/current\";

            echo '==> Ensure base dirs (must be writable by this SSH user)...';
            mkdir -p \"\$BASE_DIR/releases\";

            echo \"==> Create release: \$RELEASE_DIR\";
            mkdir -p \"\$RELEASE_DIR\";

            echo '==> Extract bundle to release...';
            tar -xzf \"/tmp/\$BUNDLE_NAME\" -C \"\$RELEASE_DIR\";
            rm -f \"/tmp/\$BUNDLE_NAME\";

            cd \"\$RELEASE_DIR\";

            echo '==> Install production deps...';
            npm ci --omit=dev || npm install --omit=dev;

            echo '==> Switch current symlink...';
            ln -sfn \"\$RELEASE_DIR\" \"\$CURRENT_DIR\";

            echo '==> Restart PM2 (run from current)...';
            cd \"\$CURRENT_DIR\";
            pm2 describe \"\$APP_NAME\" >/dev/null 2>&1 \
              && pm2 restart \"\$APP_NAME\" --update-env \
              || pm2 start npm --name \"\$APP_NAME\" -- run start -- -p 3000;

            pm2 save || true;

            echo '==> Cleanup old releases (keep last 5)...';
            ls -1dt \"\$BASE_DIR/releases\"/* 2>/dev/null | tail -n +6 | xargs -r rm -rf || true;

            echo '==> Deploy xong.';
          "

          ssh -i ~/.ssh/id_ed25519 \
            -p 22 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            -o ConnectTimeout=10 \
            "$USER@$HOST" "$REMOTE_CMD"
